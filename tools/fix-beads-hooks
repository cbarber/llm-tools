#!/usr/bin/env bash
# fix-beads-hooks - Patch beads git hooks for NixOS compatibility
#
# Beads installs git hooks with #!/bin/sh shebang which doesn't exist in NixOS.
# This script patches existing hooks to use bash from PATH.
#
# Usage:
#   fix-beads-hooks           # Fix hooks in current repo
#   fix-beads-hooks /path     # Fix hooks in specific repo

set -euo pipefail

REPO_DIR="${1:-.}"

# Use git to find hooks directory (supports both standard repos and bare worktrees)
if ! cd "$REPO_DIR" 2>/dev/null; then
  echo "Error: Directory $REPO_DIR not found" >&2
  exit 1
fi

if ! git_common_dir=$(git rev-parse --git-common-dir 2>/dev/null); then
  echo "Error: Not a git repository: $REPO_DIR" >&2
  exit 1
fi

hooks_dir="$git_common_dir/hooks"

if [[ ! -d "$hooks_dir" ]]; then
  echo "Error: Hooks directory not found: $hooks_dir" >&2
  exit 1
fi

echo "Patching beads git hooks in: $hooks_dir"
echo

patched=0
for hook in "$hooks_dir/pre-commit" \
            "$hooks_dir/post-checkout" \
            "$hooks_dir/post-merge" \
            "$hooks_dir/pre-push"; do
  if [[ ! -f "$hook" ]]; then
    continue
  fi
  
  shebang=$(head -1 "$hook")
  
  # Skip if already using portable shebang
  if [[ "$shebang" == "#!/usr/bin/env sh" ]] || [[ "$shebang" == "#!/usr/bin/env bash" ]]; then
    continue
  fi
  
  # Only patch if it has a broken shebang (#!/bin/sh)
  if [[ "$shebang" == "#!/bin/sh" ]]; then
    sed -i '1s|^#!/bin/sh|#!/usr/bin/env sh|' "$hook"
    echo "âœ“ Patched: $(basename "$hook")"
    echo "  Old: $shebang"
    echo "  New: #!/usr/bin/env sh"
    ((patched++))
  fi
done

echo
if [[ $patched -eq 0 ]]; then
  echo "No hooks needed patching"
else
  echo "Patched $patched hook(s) successfully"
  echo "Test with: $hooks_dir/post-checkout HEAD HEAD 1"
fi
