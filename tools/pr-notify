#!/usr/bin/env bash
# Inject PR status updates into active OpenCode sessions
# Usage: pr-notify [--dry-run] [pr-number] [custom-message]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Parse flags
DRY_RUN=false
if [[ "${1:-}" == "--dry-run" ]]; then
    DRY_RUN=true
    shift
fi

PR_NUMBER="${1:-}"
CUSTOM_MESSAGE="${2:-}"
EXPLICIT_SESSION="${3:-}"

if [[ -n "$EXPLICIT_SESSION" ]]; then
    echo "Using explicit session: $EXPLICIT_SESSION" >&2
    if [[ -z "$CUSTOM_MESSAGE" ]]; then
        echo "ERROR: Explicit session requires custom message" >&2
        exit 1
    fi
    bash "${SCRIPT_DIR}/anvil" --session "$EXPLICIT_SESSION" "$CUSTOM_MESSAGE"
    exit 0
fi

# Extract session ID from PR description if PR number provided
if [[ -z "$PR_NUMBER" ]]; then
    echo "ERROR: PR number required" >&2
    echo "Usage: pr-notify <pr-number> [custom-message]" >&2
    exit 1
fi

# Get PR info to extract session ID
PR_INFO=$(bash "${SCRIPT_DIR}/forge" pr view "$PR_NUMBER" --json 2>/dev/null)
if [[ -z "$PR_INFO" ]]; then
    echo "Failed to get PR #$PR_NUMBER info" >&2
    exit 1
fi

# Extract session ID from PR body using pattern: session(opencode): <id>
PR_BODY=$(echo "$PR_INFO" | jq -r '.body // ""')
SESSION_ID=$(echo "$PR_BODY" | grep -oP 'session\(opencode\):\s*\K[^\s]+' | head -1)

if [[ -z "$SESSION_ID" ]]; then
    echo "No session ID in PR #$PR_NUMBER description, checking git commits..." >&2
    
    # Fallback: check commits in current branch for session ID
    SESSION_ID=$(git log origin/main..HEAD --format=%B | grep -oP 'session\(opencode\):\s*\K[^\s]+' | head -1)
    
    if [[ -z "$SESSION_ID" ]]; then
        echo "ERROR: No session ID found in PR description or git commits" >&2
        echo "  Checked PR body for: session(opencode): <session-id>" >&2
        echo "  Checked git commits in current branch" >&2
        echo "  Ensure session ID injection is enabled (OPENCODE_SESSION_ID env var)" >&2
        exit 1
    fi
    
    echo "Found session ID in git commits: $SESSION_ID" >&2
else
    echo "Found session ID in PR description: $SESSION_ID" >&2
fi

# Build notification message
if [[ -n "$CUSTOM_MESSAGE" ]]; then
    PR_CONTEXT="$CUSTOM_MESSAGE"
else
    # Check for new comments using JSON output
    COMMENTS=$(bash "${SCRIPT_DIR}/forge" pr comments "$PR_NUMBER" --json 2>/dev/null || echo "[]")
    COMMENT_COUNT=$(echo "$COMMENTS" | jq 'length')
    
    # Format PR update context
    PR_CONTEXT=$(cat <<EOF
<pr-update>
PR #$PR_NUMBER Update:

$(echo "$PR_INFO" | jq -r '"\(.title) - \(.state)"')

Comments: $COMMENT_COUNT

Run \`forge pr view $PR_NUMBER\` for full details.
</pr-update>
EOF
)
fi

# Send message using anvil (unless dry-run)
if [[ "$DRY_RUN" == "true" ]]; then
    echo "[DRY-RUN] Would inject message to session $SESSION_ID" >&2
    echo "[DRY-RUN] Message preview:" >&2
    echo "$PR_CONTEXT" | head -5 >&2
    echo "[DRY-RUN] OPENCODE_API: ${OPENCODE_API:-not set}" >&2
else
    echo "Injecting PR update to session $SESSION_ID..." >&2
    if bash "${SCRIPT_DIR}/anvil" --session "$SESSION_ID" "$PR_CONTEXT" 2>&1 | grep -q "✓"; then
        echo "✓ PR update injected to session $SESSION_ID" >&2
    else
        echo "✗ Failed to inject to session $SESSION_ID" >&2
        exit 1
    fi
fi
