name: Test macOS Sandbox

on:
  push:
    branches: [ main ]
    paths:
      - 'tools/agent-sandbox.sh'
      - 'tools/macos-sandbox.sh'
      - 'tools/macos-sandbox-profile.sb'
      - '.github/workflows/test-macos-sandbox.yml'
  pull_request:
    paths:
      - 'tools/agent-sandbox.sh'
      - 'tools/macos-sandbox.sh'
      - 'tools/macos-sandbox-profile.sb'
      - '.github/workflows/test-macos-sandbox.yml'
  workflow_dispatch:

jobs:
  test-macos:
    name: Test Sandbox on macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9
      
      - name: Debug - Show generated profile
        run: |
          echo "=== Generated Sandbox Profile ==="
          export AGENT_SANDBOX_DEBUG=true
          ./tools/agent-sandbox.sh echo "test" 2>&1 || true
          echo "=== End Profile ==="
      
      - name: Experiment 1 - Test subpath on non-existent directory
        continue-on-error: true
        run: |
          echo "=== Testing if (subpath ...) on non-existent dir causes abort ==="
          cat > /tmp/test-profile-1.sb <<'EOF'
          (version 1)
          (deny default)
          (allow process-exec)
          (allow file-read*
            (subpath "/nix")
            (subpath "/Users/runner/.config/does-not-exist"))
          EOF
          sandbox-exec -f /tmp/test-profile-1.sb echo "SUCCESS: subpath on non-existent dir works"
      
      - name: Experiment 2 - Test with dtruss to see file access
        continue-on-error: true
        run: |
          echo "=== Using dtruss to see what files sandbox-exec tries to access ==="
          # Create minimal profile
          cat > /tmp/test-profile-2.sb <<'EOF'
          (version 1)
          (deny default)
          (allow process-exec)
          (allow file-read* (subpath "/nix"))
          EOF
          # Run with dtruss (requires sudo but may not work in CI)
          sudo dtruss -f sandbox-exec -f /tmp/test-profile-2.sb echo "test" 2>&1 | grep -E "(open|stat|access)" | head -50 || echo "dtruss not available or failed"
      
      - name: Experiment 3 - Test our actual profile with strace equivalent
        continue-on-error: true
        run: |
          echo "=== Trying to trace our actual sandbox invocation ==="
          # Use fs_usage if available (logs filesystem activity)
          sudo fs_usage -w -f filesys ./tools/agent-sandbox.sh echo "test" 2>&1 | head -100 || echo "fs_usage not available"
      
      - name: Experiment 4 - Test minimal profile that should work
        continue-on-error: true
        run: |
          echo "=== Testing minimal known-good profile ==="
          cat > /tmp/test-profile-4.sb <<'EOF'
          (version 1)
          (deny default)
          (allow process-exec)
          (allow process-fork)
          (allow file-read* file-write* file-ioctl (literal "/dev/null"))
          (allow file-read*
            (subpath "/bin")
            (subpath "/usr/bin")
            (subpath "/usr/lib"))
          EOF
          sandbox-exec -f /tmp/test-profile-4.sb echo "SUCCESS: minimal profile works"
      
      - name: Test sandbox basic functionality
        run: |
          # Test that sandbox-exec is available
          which sandbox-exec
          
          # Test basic command execution
          echo "=== Test 1: Basic command execution ==="
          ./tools/agent-sandbox.sh echo "Hello from sandbox"
      
      - name: Test filesystem restrictions
        run: |
          echo "=== Test 2: Project directory access (should work) ==="
          ./tools/agent-sandbox.sh touch test-file.txt
          ./tools/agent-sandbox.sh rm test-file.txt
          
          echo "=== Test 3: Home directory access (should be restricted) ==="
          # Test that personal directories cannot be written to
          if ./tools/agent-sandbox.sh touch ~/Documents/sandbox-test.txt 2>/dev/null; then
            echo "ERROR: Should not be able to write to ~/Documents"
            exit 1
          else
            echo "PASS: Cannot write to ~/Documents (as expected)"
          fi
          
          # Test that sensitive files cannot be read
          echo "=== Test 3a: Sensitive file read restrictions ==="
          mkdir -p ~/.ssh ~/.config/gh
          echo "fake-ssh-key" > ~/.ssh/id_rsa
          echo "fake-gh-token" > ~/.config/gh/hosts.yml
          
          if ./tools/agent-sandbox.sh cat ~/.ssh/id_rsa 2>/dev/null | grep -q "fake-ssh-key"; then
            echo "ERROR: Should not be able to read ~/.ssh/id_rsa"
            exit 1
          else
            echo "PASS: Cannot read personal SSH keys (as expected)"
          fi
          
          if ./tools/agent-sandbox.sh cat ~/.config/gh/hosts.yml 2>/dev/null | grep -q "fake-gh-token"; then
            echo "ERROR: Should not be able to read ~/.config/gh/hosts.yml"
            exit 1
          else
            echo "PASS: Cannot read GitHub CLI credentials (as expected)"
          fi
      
      - name: Test agent config directories
        run: |
          echo "=== Test 4: Agent config directories (should work) ==="
          
          # Create config dirs if they don't exist
          mkdir -p ~/.config/opencode ~/.claude
          
          # Test write access to opencode config
          ./tools/agent-sandbox.sh touch ~/.config/opencode/test.txt
          ./tools/agent-sandbox.sh rm ~/.config/opencode/test.txt
          
          # Test write access to claude directory (not ~/.config/claude)
          ./tools/agent-sandbox.sh touch ~/.claude/test.txt
          ./tools/agent-sandbox.sh rm ~/.claude/test.txt
          
          echo "PASS: Can write to agent config directories"
      
      - name: Test network access
        run: |
          echo "=== Test 5: Network access (should work) ==="
          # Test network with a simple command that's already available
          # ping is available by default on macOS
          ./tools/agent-sandbox.sh ping -c 1 google.com && echo "PASS: Network access works"
      
      - name: Test workspace directory
        run: |
          echo "=== Test 6: Workspace directory access ==="
          ./tools/agent-sandbox.sh bash -c 'echo "AGENT_WORK_DIR=$AGENT_WORK_DIR"; ls -la $AGENT_WORK_DIR; touch $AGENT_WORK_DIR/test.txt'
      
      - name: Test nix operations
        run: |
          echo "=== Test 7: Nix operations (should work) ==="
          # Nix needs ~/.cache/nix to exist (can't create parent dirs in sandbox)
          mkdir -p ~/.cache/nix
          ./tools/agent-sandbox.sh nix-shell -p hello --run hello
      
      - name: Test BWRAP_EXTRA_PATHS
        run: |
          echo "=== Test 8: Extra paths mounting ==="
          mkdir -p /tmp/extra-test-dir
          echo "test content" > /tmp/extra-test-dir/test.txt
          
          export BWRAP_EXTRA_PATHS="/tmp/extra-test-dir"
          ./tools/agent-sandbox.sh cat /tmp/extra-test-dir/test.txt
          
          rm -rf /tmp/extra-test-dir
      
      - name: Test IN_AGENT_SANDBOX variable
        run: |
          echo "=== Test 9: IN_AGENT_SANDBOX environment variable ==="
          ./tools/agent-sandbox.sh bash -c 'if [[ "$IN_AGENT_SANDBOX" == "1" ]]; then echo "PASS: IN_AGENT_SANDBOX is set"; else echo "ERROR: IN_AGENT_SANDBOX not set"; exit 1; fi'
      
      - name: Summary
        run: |
          echo "=========================================="
          echo "All macOS sandbox tests passed!"
          echo "=========================================="
